# Kong API 日誌處理管道配置
# Logstash configuration for Kong API Gateway logs

input {
  http {
    port => 8080
    codec => json
    response_headers => {
      "Access-Control-Allow-Origin" => "*"
      "Access-Control-Allow-Methods" => "POST, GET, OPTIONS"
      "Access-Control-Allow-Headers" => "Content-Type"
    }
  }
}

filter {
  # 解析 Kong 日誌時間戳
  if [started_at] {
    date {
      match => [ "started_at", "UNIX_MS" ]
      target => "@timestamp"
    }
  }

  # 計算響應時間指標
  if [latencies] {
    mutate {
      add_field => { "total_latency" => "%{[latencies][request]}" }
      add_field => { "proxy_latency" => "%{[latencies][proxy]}" }
      add_field => { "kong_latency" => "%{[latencies][kong]}" }
    }
    
    # 轉換延遲欄位為數字類型
    mutate {
      convert => { 
        "total_latency" => "integer" 
        "proxy_latency" => "integer"
        "kong_latency" => "integer"
      }
    }
  }

  # 提取 HTTP 方法和狀態碼
  if [request] and [request][method] {
    mutate {
      add_field => { "http_method" => "%{[request][method]}" }
    }
  }
  
  if [response] and [response][status] {
    mutate {
      add_field => { "http_status" => "%{[response][status]}" }
    }
    
    # 分類響應狀態
    if [http_status] >= 200 and [http_status] < 300 {
      mutate { add_field => { "response_category" => "success" } }
    } else if [http_status] >= 300 and [http_status] < 400 {
      mutate { add_field => { "response_category" => "redirect" } }
    } else if [http_status] >= 400 and [http_status] < 500 {
      mutate { add_field => { "response_category" => "client_error" } }
    } else if [http_status] >= 500 {
      mutate { add_field => { "response_category" => "server_error" } }
    }
  }

  # 提取服務和路由資訊
  if [service] and [service][name] {
    mutate {
      add_field => { "service_name" => "%{[service][name]}" }
    }
  }
  
  if [route] and [route][name] {
    mutate {
      add_field => { "route_name" => "%{[route][name]}" }
    }
  }

  # 提取用戶端 IP
  if [client_ip] {
    mutate {
      add_field => { "client_address" => "%{[client_ip]}" }
    }
  }

  # 提取 User-Agent
  if [request] and [request][headers] and [request][headers][user-agent] {
    mutate {
      add_field => { "user_agent" => "%{[request][headers][user-agent]}" }
    }
  }

  # 計算請求大小
  if [request] and [request][size] {
    mutate {
      add_field => { "request_size" => "%{[request][size]}" }
      convert => { "request_size" => "integer" }
    }
  }

  # 計算回應大小
  if [response] and [response][size] {
    mutate {
      add_field => { "response_size" => "%{[response][size]}" }
      convert => { "response_size" => "integer" }
    }
  }

  # 添加處理時間戳
  mutate {
    add_field => { "processed_at" => "%{@timestamp}" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "kong-api-logs-%{+YYYY.MM.dd}"
    template_name => "kong-logs"
    template => "/usr/share/logstash/templates/kong-template.json"
    template_overwrite => true
  }

  # 除錯輸出 (可在開發時啟用)
  # stdout { 
  #   codec => rubydebug 
  # }
}